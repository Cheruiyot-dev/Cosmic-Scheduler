"use strict";var z=Object.create;var j=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames,S=Object.getOwnPropertySymbols,Y=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var H=(e,t,i)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,g=(e,t)=>{for(var i in t||(t={}))M.call(t,i)&&H(e,i,t[i]);if(S)for(var i of S(t))Z.call(t,i)&&H(e,i,t[i]);return e};var ee=(e,t)=>{for(var i in t)j(e,i,{get:t[i],enumerable:!0})},U=(e,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of X(t))!M.call(e,n)&&n!==i&&j(e,n,{get:()=>t[n],enumerable:!(r=J(t,n))||r.enumerable});return e};var v=(e,t,i)=>(i=e!=null?z(Y(e)):{},U(t||!e||!e.__esModule?j(i,"default",{value:e,enumerable:!0}):i,e)),te=e=>U(j({},"__esModule",{value:!0}),e);var s=(e,t,i)=>new Promise((r,n)=>{var o=p=>{try{d(i.next(p))}catch(y){n(y)}},m=p=>{try{d(i.throw(p))}catch(y){n(y)}},d=p=>p.done?r(p.value):Promise.resolve(p.value).then(o,m);d((i=i.apply(e,t)).next())});var pe={};ee(pe,{createBucketClient:()=>N});module.exports=te(pe);var re={production:{v3:{apiUrl:"https://api.cosmicjs.com/v3",uploadUrl:"https://workers.cosmicjs.com/v3"}},staging:{v3:{apiUrl:"https://api.cosmic-staging.com/v3",uploadUrl:"https://workers.cosmic-staging.com/v3"}}},C=re;function B(e){if(e.custom){if(!e.custom.apiUrl||!e.custom.uploadUrl)throw new Error("apiUrl or uploadUrl is missing from 'custom' option");return{apiUrl:e.custom.apiUrl,uploadUrl:e.custom.uploadUrl}}if(!e.apiVersion||!["v3"].includes(e.apiVersion))throw new Error("apiVersion value can only be from 'v1', 'v2' & 'v3'");if(!e.apiEnvironment||!["production","staging"].includes(e.apiEnvironment))throw new Error("apiEnvironment value can only be from 'production' & 'staging'");return C[e.apiEnvironment][e.apiVersion]}var I=v(require("form-data"));var ie={POST:"post",GET:"get",FETCH:"fetch",PUT:"put",PATCH:"patch",DELETE:"delete"},a=ie;var G=v(require("axios"));var c=(e,t,i,r)=>(0,G.default)({method:e,url:t,data:i,headers:r}).then(o=>o.data).catch(o=>{throw o.response?o.response.data:o.response});function u(e){if(e&&e.trim())return{Authorization:`Bearer ${e}`};throw new Error("'writeKey' should be a valid string")}var K=v(require("axios")),_=(e,t,i,r)=>(0,K.default)({method:e,url:t,data:i,headers:r});var ne=e=>new Promise((t,i)=>{_(a.GET,e).then(r=>t(r.data)).catch(r=>i(r.response?r.response.data:r.response))}),f=(e,t,i)=>s(void 0,null,function*(){try{let r=yield ne(e);i(r)}catch(r){if(t&&typeof t=="function")t(r);else throw r}});var l=class{constructor(t){this.endpoint="";this.endpoint=t}props(t){let i;if(typeof t=="string")i=t.startsWith("{")&&t.endsWith("}")?this.parseGraphQLProps(t.slice(1,-1)):t;else if(Array.isArray(t))i=t.filter(r=>typeof r=="string").map(r=>r.trim()).filter(Boolean).join(",");else throw new Error("Invalid props type");return this.endpoint+=`&props=${encodeURIComponent(i)}`,this}parseGraphQLProps(t){let i=t.split(`
`).map(o=>o.trim()).filter(Boolean),r=[],n=[];for(let o of i)if(o.includes("{")){let[m]=o.split("{");m!==void 0&&n.push(m.trim())}else o==="}"?n.pop():r.push([...n,o].join("."));return r.join(",")}sort(t){return this.endpoint+=`&sort=${t}`,this}skip(t){return this.endpoint+=`&skip=${t}`,this}useCache(){return this.endpoint+="&use_cache=true",this}};var O=class extends l{limit(t){return this.endpoint+=`&limit=${t}`,this}then(t,i){return s(this,null,function*(){yield f(this.endpoint,i,r=>t==null?void 0:t(r))})}};var w=class extends l{then(t,i){return s(this,null,function*(){yield f(this.endpoint,i,r=>{let n=r.media&&r.media.length?r.media[0]:null;t==null||t({media:n})})})}};var b=e=>e?`&query=${encodeURIComponent(JSON.stringify(e))}`:"";var E,D=(e,t)=>({find(r){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/media?read_key=${e.readKey}${b(r)}`;return new O(n)},findOne(r){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/media?read_key=${e.readKey}&limit=1${b(r)}`;return new w(n)},insertOne(r){return s(this,null,function*(){let n=`${t.uploadUrl}/buckets/${e.bucketSlug}/media`,o=new I.default;return r.media.buffer?o.append("media",r.media.buffer,r.media.originalname):o.append("media",r.media,r.media.name),e.writeKey&&o.append("write_key",e.writeKey),r.folder&&o.append("folder",r.folder),r.metadata&&o.append("metadata",JSON.stringify(r.metadata)),r.trigger_webhook&&o.append("trigger_webhook",r.trigger_webhook.toString()),(d=>new Promise((p,y)=>{r.media.buffer?d.getLength((A,Q)=>{A&&y(A);let V=g({"Content-Length":Q},d.getHeaders());p(V)}):p({"Content-Type":"multipart/form-data"})}))(o).then(d=>{let p=d;return e.writeKey&&(p.Authorization=`Bearer ${e.writeKey}`),c(a.POST,n,o,p)}).catch(d=>{throw d.response.data})})},updateOne(r,n){return s(this,null,function*(){let o=`${t.apiUrl}/buckets/${e.bucketSlug}/media/${r}`;return E=u(e.writeKey),c(a.PATCH,o,n,E)})},deleteOne(r,n=!1){return s(this,null,function*(){let o=`${t.apiUrl}/buckets/${e.bucketSlug}/media/${r}${n?"?trigger_webhook=true":""}`;return E=u(e.writeKey),c(a.DELETE,o,null,E)})}});var h=class extends l{depth(t){return this.endpoint+=`&depth=${t}`,this}status(t){return this.endpoint+=`&status=${t}`,this}after(t){return this.endpoint+=`&after=${t}`,this}options(t){return t&&(this.opts=t),this}};var oe=(e,t,i)=>s(void 0,null,function*(){let r={name:{$in:t}},{media:n}=yield e.media.find(r).props(!i||i==="all"?"":`name,url,imgix_url,${i}`);return n}),se=e=>{let t=[];return JSON.stringify(e,(i,r)=>{if(r&&typeof r=="object"){let n=r.imgix_url||r.url;n&&t.push(n.split("/").pop().split("?")[0])}return r}),[...new Set(t)]},ae=(e,t,i)=>{let r=new Map(t.map(o=>[o.name,o])),n=o=>{o&&typeof o=="object"&&Object.keys(o).forEach(m=>{if(o[m]&&typeof o[m]=="object"){let d=o[m].imgix_url||o[m].url;if(d){let p=d.split("/").pop().split("?")[0];if(r.has(p)){i.includes("name")||delete r.get(p).name;let y=g({},r.get(p));Object.assign(o[m],y)}}n(o[m])}})};n(e)},R=(e,t,i)=>s(void 0,null,function*(){let r=n=>s(void 0,null,function*(){let o=se(n);if(o.length>0){let m=yield oe(t,o,i);ae(n,m,i)}return n});return Array.isArray(e)?Promise.all(e.map(n=>r(n))):r(e)});var P=class extends h{constructor(i,r){super(i);this.bucketConfig=r}limit(i){return this.endpoint+=`&limit=${i}`,this}then(i,r){return s(this,null,function*(){yield f(this.endpoint,r,n=>s(this,null,function*(){this.opts&&this.opts.media&&n.objects&&(n.objects=yield R(n.objects,k(this.bucketConfig),this.opts.media.props)),i==null||i(n)}))})}};var x=class extends h{constructor(i,r){super(i);this.bucketConfig=r}then(i,r){return s(this,null,function*(){yield f(this.endpoint,r,n=>s(this,null,function*(){let o=n.objects&&n.objects.length?n.objects[0]:null;this.opts&&this.opts.media&&o&&(o=yield R(o,k(this.bucketConfig),this.opts.media.props)),i==null||i({object:o})}))})}};var T,F=(e,t)=>({find(r){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/objects?read_key=${e.readKey}${b(r)}`;return new P(n,e)},findOne(r){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/objects?read_key=${e.readKey}&limit=1${b(r)}`;return new x(n,e)},insertOne(r){return s(this,null,function*(){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/objects`;return T=u(e.writeKey),c(a.POST,n,r,T)})},updateOne(r,n){return s(this,null,function*(){let o=`${t.apiUrl}/buckets/${e.bucketSlug}/objects/${r}`;return T=u(e.writeKey),c(a.PATCH,o,n,T)})},deleteOne(r,n=!1){return s(this,null,function*(){let o=`${t.apiUrl}/buckets/${e.bucketSlug}/objects/${r}${n?"?trigger_webhook=true":""}`;return T=u(e.writeKey),c(a.DELETE,o,null,T)})}});var $,q=(e,t)=>({find(){let r=`${t.apiUrl}/buckets/${e.bucketSlug}/object-types?read_key=${e.readKey}`;return c(a.GET,r)},findOne(r){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/object-types/${r}?read_key=${e.readKey}`;return c(a.GET,n)},insertOne(r){return s(this,null,function*(){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/object-types`;return $=u(e.writeKey),c(a.POST,n,r,$)})},updateOne(r,n){return s(this,null,function*(){let o=`${t.apiUrl}/buckets/${e.bucketSlug}/object-types/${r}`;return $=u(e.writeKey),c(a.PATCH,o,n,$)})},deleteOne(r){return s(this,null,function*(){let n=`${t.apiUrl}/buckets/${e.bucketSlug}/object-types/${r}`;return $=u(e.writeKey),c(a.DELETE,n,null,$)})}});var W,L=(e,t)=>({insertOne(r,n){return s(this,null,function*(){let o=`${t.apiUrl}/buckets/${e.bucketSlug}/objects/${r}/revisions`;return W=u(e.writeKey),c(a.POST,o,n,W)})}});var k=e=>{let t=g({apiVersion:"v3",apiEnvironment:"production"},e),i=B(t);return{objects:F(t,i),objectTypes:q(t,i),objectRevisions:L(t,i),media:D(t,i)}},N=k;0&&(module.exports={createBucketClient});
