var D=Object.defineProperty;var v=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var A=(e,r,n)=>r in e?D(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n,g=(e,r)=>{for(var n in r||(r={}))F.call(r,n)&&A(e,n,r[n]);if(v)for(var n of v(r))q.call(r,n)&&A(e,n,r[n]);return e};var s=(e,r,n)=>new Promise((t,i)=>{var o=p=>{try{d(n.next(p))}catch(y){i(y)}},m=p=>{try{d(n.throw(p))}catch(y){i(y)}},d=p=>p.done?t(p.value):Promise.resolve(p.value).then(o,m);d((n=n.apply(e,r)).next())});var W={production:{v3:{apiUrl:"https://api.cosmicjs.com/v3",uploadUrl:"https://workers.cosmicjs.com/v3"}},staging:{v3:{apiUrl:"https://api.cosmic-staging.com/v3",uploadUrl:"https://workers.cosmic-staging.com/v3"}}},S=W;function H(e){if(e.custom){if(!e.custom.apiUrl||!e.custom.uploadUrl)throw new Error("apiUrl or uploadUrl is missing from 'custom' option");return{apiUrl:e.custom.apiUrl,uploadUrl:e.custom.uploadUrl}}if(!e.apiVersion||!["v3"].includes(e.apiVersion))throw new Error("apiVersion value can only be from 'v1', 'v2' & 'v3'");if(!e.apiEnvironment||!["production","staging"].includes(e.apiEnvironment))throw new Error("apiEnvironment value can only be from 'production' & 'staging'");return S[e.apiEnvironment][e.apiVersion]}import z from"form-data";var L={POST:"post",GET:"get",FETCH:"fetch",PUT:"put",PATCH:"patch",DELETE:"delete"},a=L;import N from"axios";var c=(e,r,n,t)=>N({method:e,url:r,data:n,headers:t}).then(o=>o.data).catch(o=>{throw o.response?o.response.data:o.response});function u(e){if(e&&e.trim())return{Authorization:`Bearer ${e}`};throw new Error("'writeKey' should be a valid string")}import Q from"axios";var M=(e,r,n,t)=>Q({method:e,url:r,data:n,headers:t});var V=e=>new Promise((r,n)=>{M(a.GET,e).then(t=>r(t.data)).catch(t=>n(t.response?t.response.data:t.response))}),f=(e,r,n)=>s(void 0,null,function*(){try{let t=yield V(e);n(t)}catch(t){if(r&&typeof r=="function")r(t);else throw t}});var l=class{constructor(r){this.endpoint="";this.endpoint=r}props(r){let n;if(typeof r=="string")n=r.startsWith("{")&&r.endsWith("}")?this.parseGraphQLProps(r.slice(1,-1)):r;else if(Array.isArray(r))n=r.filter(t=>typeof t=="string").map(t=>t.trim()).filter(Boolean).join(",");else throw new Error("Invalid props type");return this.endpoint+=`&props=${encodeURIComponent(n)}`,this}parseGraphQLProps(r){let n=r.split(`
`).map(o=>o.trim()).filter(Boolean),t=[],i=[];for(let o of n)if(o.includes("{")){let[m]=o.split("{");m!==void 0&&i.push(m.trim())}else o==="}"?i.pop():t.push([...i,o].join("."));return t.join(",")}sort(r){return this.endpoint+=`&sort=${r}`,this}skip(r){return this.endpoint+=`&skip=${r}`,this}useCache(){return this.endpoint+="&use_cache=true",this}};var j=class extends l{limit(r){return this.endpoint+=`&limit=${r}`,this}then(r,n){return s(this,null,function*(){yield f(this.endpoint,n,t=>r==null?void 0:r(t))})}};var O=class extends l{then(r,n){return s(this,null,function*(){yield f(this.endpoint,n,t=>{let i=t.media&&t.media.length?t.media[0]:null;r==null||r({media:i})})})}};var b=e=>e?`&query=${encodeURIComponent(JSON.stringify(e))}`:"";var x,U=(e,r)=>({find(t){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/media?read_key=${e.readKey}${b(t)}`;return new j(i)},findOne(t){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/media?read_key=${e.readKey}&limit=1${b(t)}`;return new O(i)},insertOne(t){return s(this,null,function*(){let i=`${r.uploadUrl}/buckets/${e.bucketSlug}/media`,o=new z;return t.media.buffer?o.append("media",t.media.buffer,t.media.originalname):o.append("media",t.media,t.media.name),e.writeKey&&o.append("write_key",e.writeKey),t.folder&&o.append("folder",t.folder),t.metadata&&o.append("metadata",JSON.stringify(t.metadata)),t.trigger_webhook&&o.append("trigger_webhook",t.trigger_webhook.toString()),(d=>new Promise((p,y)=>{t.media.buffer?d.getLength((R,_)=>{R&&y(R);let I=g({"Content-Length":_},d.getHeaders());p(I)}):p({"Content-Type":"multipart/form-data"})}))(o).then(d=>{let p=d;return e.writeKey&&(p.Authorization=`Bearer ${e.writeKey}`),c(a.POST,i,o,p)}).catch(d=>{throw d.response.data})})},updateOne(t,i){return s(this,null,function*(){let o=`${r.apiUrl}/buckets/${e.bucketSlug}/media/${t}`;return x=u(e.writeKey),c(a.PATCH,o,i,x)})},deleteOne(t,i=!1){return s(this,null,function*(){let o=`${r.apiUrl}/buckets/${e.bucketSlug}/media/${t}${i?"?trigger_webhook=true":""}`;return x=u(e.writeKey),c(a.DELETE,o,null,x)})}});var h=class extends l{depth(r){return this.endpoint+=`&depth=${r}`,this}status(r){return this.endpoint+=`&status=${r}`,this}after(r){return this.endpoint+=`&after=${r}`,this}options(r){return r&&(this.opts=r),this}};var J=(e,r,n)=>s(void 0,null,function*(){let t={name:{$in:r}},{media:i}=yield e.media.find(t).props(!n||n==="all"?"":`name,url,imgix_url,${n}`);return i}),X=e=>{let r=[];return JSON.stringify(e,(n,t)=>{if(t&&typeof t=="object"){let i=t.imgix_url||t.url;i&&r.push(i.split("/").pop().split("?")[0])}return t}),[...new Set(r)]},Y=(e,r,n)=>{let t=new Map(r.map(o=>[o.name,o])),i=o=>{o&&typeof o=="object"&&Object.keys(o).forEach(m=>{if(o[m]&&typeof o[m]=="object"){let d=o[m].imgix_url||o[m].url;if(d){let p=d.split("/").pop().split("?")[0];if(t.has(p)){n.includes("name")||delete t.get(p).name;let y=g({},t.get(p));Object.assign(o[m],y)}}i(o[m])}})};i(e)},E=(e,r,n)=>s(void 0,null,function*(){let t=i=>s(void 0,null,function*(){let o=X(i);if(o.length>0){let m=yield J(r,o,n);Y(i,m,n)}return i});return Array.isArray(e)?Promise.all(e.map(i=>t(i))):t(e)});var w=class extends h{constructor(n,t){super(n);this.bucketConfig=t}limit(n){return this.endpoint+=`&limit=${n}`,this}then(n,t){return s(this,null,function*(){yield f(this.endpoint,t,i=>s(this,null,function*(){this.opts&&this.opts.media&&i.objects&&(i.objects=yield E(i.objects,P(this.bucketConfig),this.opts.media.props)),n==null||n(i)}))})}};var k=class extends h{constructor(n,t){super(n);this.bucketConfig=t}then(n,t){return s(this,null,function*(){yield f(this.endpoint,t,i=>s(this,null,function*(){let o=i.objects&&i.objects.length?i.objects[0]:null;this.opts&&this.opts.media&&o&&(o=yield E(o,P(this.bucketConfig),this.opts.media.props)),n==null||n({object:o})}))})}};var T,C=(e,r)=>({find(t){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/objects?read_key=${e.readKey}${b(t)}`;return new w(i,e)},findOne(t){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/objects?read_key=${e.readKey}&limit=1${b(t)}`;return new k(i,e)},insertOne(t){return s(this,null,function*(){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/objects`;return T=u(e.writeKey),c(a.POST,i,t,T)})},updateOne(t,i){return s(this,null,function*(){let o=`${r.apiUrl}/buckets/${e.bucketSlug}/objects/${t}`;return T=u(e.writeKey),c(a.PATCH,o,i,T)})},deleteOne(t,i=!1){return s(this,null,function*(){let o=`${r.apiUrl}/buckets/${e.bucketSlug}/objects/${t}${i?"?trigger_webhook=true":""}`;return T=u(e.writeKey),c(a.DELETE,o,null,T)})}});var $,B=(e,r)=>({find(){let t=`${r.apiUrl}/buckets/${e.bucketSlug}/object-types?read_key=${e.readKey}`;return c(a.GET,t)},findOne(t){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/object-types/${t}?read_key=${e.readKey}`;return c(a.GET,i)},insertOne(t){return s(this,null,function*(){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/object-types`;return $=u(e.writeKey),c(a.POST,i,t,$)})},updateOne(t,i){return s(this,null,function*(){let o=`${r.apiUrl}/buckets/${e.bucketSlug}/object-types/${t}`;return $=u(e.writeKey),c(a.PATCH,o,i,$)})},deleteOne(t){return s(this,null,function*(){let i=`${r.apiUrl}/buckets/${e.bucketSlug}/object-types/${t}`;return $=u(e.writeKey),c(a.DELETE,i,null,$)})}});var G,K=(e,r)=>({insertOne(t,i){return s(this,null,function*(){let o=`${r.apiUrl}/buckets/${e.bucketSlug}/objects/${t}/revisions`;return G=u(e.writeKey),c(a.POST,o,i,G)})}});var P=e=>{let r=g({apiVersion:"v3",apiEnvironment:"production"},e),n=H(r);return{objects:C(r,n),objectTypes:B(r,n),objectRevisions:K(r,n),media:U(r,n)}},Z=P;export{Z as createBucketClient};
